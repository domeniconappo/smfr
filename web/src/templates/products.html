{% extends "base.html" %}

{% block styles%}
    {{ super() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
   integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
   crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
{% endblock %}

{% block app_content %}
<div class="row">
    <div class="col-lg-5">
        <table class="table table-striped table-bordered table-list">
        <thead>
            <tr>
                <th>Filename</th>
                <th>Date</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
        {%  if files %}
      {% for f in files %}
            <tr>
                <td><a href="/products?date={{ f.date }}">{{ f.name }}</a></td>
                <td>{{ f.date }}</td>
                <td><p>
                    {{ f.efas_regions }}
                    {{ f.reported_regions }}

                </p></td>
            </tr>
      {% endfor %}
        {% endif %}
        </tbody>
      </table>
    </div>

    <div class="col-lg-7">
        <div class="panel panel-default panel-table">
            <div class="panel-heading">
                <h3 class="panel-title">MAP</h3>
            </div>
            <div class="panel-body">
                <div id="product_map"></div>
            </div>
        </div>
    </div>
</div>

    {% if development %}
        <div class="row"><div class="col-lg-12">
            <div class="panel panel-default panel-table">
            <div class="panel-heading">
                <h3 class="panel-title">Geojson content</h3>
            </div>
            <div class="panel-body">
                {{ geojson | tojson  }}
            </div>
        </div>
        </div></div>
    {% endif %}
{{ super() }}
{% endblock app_content %}


{% block scripts %}
    {{ super() }}
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
   integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
   crossorigin="">
    </script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script>
    $(document).ready(function() {

        var clat = 55.0;
        var clon = 15.0;
        var map = L.map('product_map').setView([clat, clon], 4);
        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZG9tZW5pY28tbmFwcG8iLCJhIjoiY2ptdnowNTQzMGMzeDNxbmtyeHlva2JuNiJ9.VI1pXr3ZUdnN31NwbUgIEw', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox.streets'
        }).addTo(map);

        {% if geojson %}
            var features = {{ geojson | tojson }};
            L.geoJSON(features, {
                 style: function(feature) {
                    switch (feature.properties.risk_color) {
                        case '225 225 225': return {color: "#292929", weight: 3, opacity: 0.9, fillColor: "#575757"};
                        case '255 0 0': return {color: "#ff0000", weight: 5, opacity: 0.9, fillColor: "#ff646e"};
                        case '255 128 0': return {color: "#ffb21a", weight: 4, opacity: 0.9, fillColor: "#ffb01c"};
                    }
                 }
            }).addTo(map);
        {% endif %}

        var markers = L.markerClusterGroup({
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: true,
            zoomToBoundsOnClick: true
        });

        function onEachFeature(feature, layer) {
            // does this feature have a property named popupContent?
            if (feature.properties && feature.properties.popupContent) {
                layer.bindPopup(feature.properties.popupContent);
            }
        }

        //$.each(dataSet, function (index, tweet) {
        //    var tweet_lat = tweet['raw_coords'][0];
        //    var tweet_lon = tweet['raw_coords'][1];
        //    var tweet_text = tweet['Full Text'];
        //    var marker = L.marker([tweet_lat, tweet_lon]);
        //    marker.bindPopup(tweet_text);
        //    markers.addLayer(marker);
        //});

        //map.addLayer(markers);
    });
    </script>
{% endblock scripts %}